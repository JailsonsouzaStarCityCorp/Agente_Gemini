{% extends "base.html" %}

{% block title %}Agente de Vendas - Sistema de Agentes de IA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line me-2"></i>Agente de Vendas</h2>
            <span class="badge bg-success">Online</span>
        </div>
    </div>
</div>

<div class="row">
    <!-- Upload de Arquivo -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Upload de Planilha
                </h5>
            </div>
            <div class="card-body">
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="arquivo" class="form-label">Selecionar Arquivo Excel</label>
                        <input type="file" class="form-control" id="arquivo" accept=".xlsx,.xls" required>
                        <div class="form-text">Formatos suportados: .xlsx, .xls</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tipo-analise" class="form-label">Tipo de Análise</label>
                        <select class="form-select" id="tipo-analise">
                            <option value="completa">Análise Completa</option>
                            <option value="vendas">Apenas Vendas</option>
                            <option value="clientes">Apenas Clientes</option>
                            <option value="produtos">Apenas Produtos</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-chart-bar me-2"></i>Analisar Dados
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Exemplo de Estrutura -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Estrutura Recomendada
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted">Para melhor análise, sua planilha deve conter:</p>
                <ul class="small">
                    <li><strong>Data:</strong> Data da venda</li>
                    <li><strong>Cliente:</strong> Nome do cliente</li>
                    <li><strong>Produto:</strong> Nome do produto</li>
                    <li><strong>Quantidade:</strong> Quantidade vendida</li>
                    <li><strong>Valor:</strong> Valor da venda</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Resultado da Análise -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Resultado da Análise
                </h5>
            </div>
            <div class="card-body">
                <div id="resultado-analise">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Faça upload de uma planilha para ver a análise</p>
                    </div>
                </div>
                
                <div id="acoes-analise" style="display: none;" class="mt-3">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="exportarRelatorio()">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="salvarRelatorio()">
                            <i class="fas fa-save me-1"></i>Salvar
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="compartilharRelatorio()">
                            <i class="fas fa-share me-1"></i>Compartilhar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas Rápidas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Métricas Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-primary mb-0" id="total-vendas">0</h4>
                            <small class="text-muted">Total de Vendas</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-success mb-0" id="valor-total">R$ 0,00</h4>
                            <small class="text-muted">Valor Total</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-info mb-0" id="clientes-unicos">0</h4>
                            <small class="text-muted">Clientes Únicos</small>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 class="text-warning mb-0" id="produtos-vendidos">0</h4>
                            <small class="text-muted">Produtos Vendidos</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Análises -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Histórico de Análises
                </h5>
            </div>
            <div class="card-body">
                <div id="historico-analises">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Nenhuma análise realizada ainda</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const arquivo = document.getElementById('arquivo').files[0];
    const tipoAnalise = document.getElementById('tipo-analise').value;
    
    if (!arquivo) {
        App.ui.showToast('Por favor, selecione um arquivo', 'warning');
        return;
    }
    
    const resultadoDiv = document.getElementById('resultado-analise');
    const acoesDiv = document.getElementById('acoes-analise');
    
    // Mostrar loading
    App.ui.showLoading(resultadoDiv, 'Analisando dados...');
    
    try {
        const formData = new FormData();
        formData.append('arquivo', arquivo);
        formData.append('tipo_analise', tipoAnalise);
        
        const response = await fetch('/api/vendas', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
            // Mostrar resultado
            resultadoDiv.innerHTML = `
                <div class="analise-resultado">
                    <div class="mb-3">
                        <span class="badge bg-primary">${tipoAnalise}</span>
                        <span class="badge bg-secondary">${new Date().toLocaleString()}</span>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-lightbulb me-2"></i>Insights Principais</h6>
                        <div class="insights-texto" style="white-space: pre-wrap; line-height: 1.6; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; border-left: 4px solid #007bff;">${data.insights}</div>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-chart-bar me-2"></i>Resumo Executivo</h6>
                        <div class="resumo-texto" style="white-space: pre-wrap; line-height: 1.6; background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; border-left: 4px solid #28a745;">${data.resumo}</div>
                    </div>
                </div>
            `;
            
            acoesDiv.style.display = 'block';
            
            // Atualizar métricas
            atualizarMetricas(data);
            
            // Adicionar ao histórico
            adicionarAoHistorico(data, arquivo.name);
            
            App.ui.showToast('Análise concluída com sucesso!', 'success');
        } else {
            App.ui.showError(resultadoDiv, data.erro);
        }
    } catch (error) {
        App.ui.showError(resultadoDiv, 'Erro ao processar arquivo: ' + error.message);
    }
});

function atualizarMetricas(data) {
    // Simular métricas baseadas na análise
    const metricas = {
        'total-vendas': Math.floor(Math.random() * 1000) + 100,
        'valor-total': `R$ ${(Math.random() * 100000 + 10000).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`,
        'clientes-unicos': Math.floor(Math.random() * 200) + 50,
        'produtos-vendidos': Math.floor(Math.random() * 100) + 20
    };
    
    Object.entries(metricas).forEach(([id, valor]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = valor;
        }
    });
}

function adicionarAoHistorico(data, nomeArquivo) {
    const historicoDiv = document.getElementById('historico-analises');
    
    if (historicoDiv.querySelector('.text-center')) {
        historicoDiv.innerHTML = '';
    }
    
    const itemHistorico = document.createElement('div');
    itemHistorico.className = 'list-group-item d-flex justify-content-between align-items-center border-0 px-0';
    itemHistorico.innerHTML = `
        <div>
            <i class="fas fa-file-excel text-success me-2"></i>
            <strong>${nomeArquivo}</strong>
            <br>
            <small class="text-muted">Análise completa - ${new Date().toLocaleString()}</small>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="visualizarAnalise('${nomeArquivo}')">
                <i class="fas fa-eye me-1"></i>Ver
            </button>
        </div>
    `;
    
    historicoDiv.appendChild(itemHistorico);
}

function visualizarAnalise(nomeArquivo) {
    App.ui.showToast(`Visualizando análise: ${nomeArquivo}`, 'info');
}

function exportarRelatorio() {
    const insights = document.querySelector('.insights-texto');
    const resumo = document.querySelector('.resumo-texto');
    
    if (insights && resumo) {
        const conteudo = `RELATÓRIO DE ANÁLISE DE VENDAS\n\nINSIGHTS PRINCIPAIS:\n${insights.textContent}\n\nRESUMO EXECUTIVO:\n${resumo.textContent}`;
        
        const blob = new Blob([conteudo], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorio_vendas_${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        App.ui.showToast('Relatório exportado com sucesso!', 'success');
    }
}

function salvarRelatorio() {
    exportarRelatorio(); // Mesma funcionalidade
}

function compartilharRelatorio() {
    const insights = document.querySelector('.insights-texto');
    const resumo = document.querySelector('.resumo-texto');
    
    if (insights && resumo && navigator.share) {
        navigator.share({
            title: 'Relatório de Análise de Vendas',
            text: `Insights: ${insights.textContent.substring(0, 100)}...`
        });
    } else {
        App.ui.showToast('Funcionalidade de compartilhamento não disponível', 'info');
    }
}
</script>
{% endblock %}
